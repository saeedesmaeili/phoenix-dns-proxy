<p align="center">
<img src="docs/images/logo.png" alt="Phoenix Logo" height="200">
</p>

# DNS Transparent Proxy with Whitelist

This project provides a **transparent DNS + TCP proxy** setup on **Ubuntu** that:
- Hijacks DNS queries for specific domains (e.g., Mojang, Microsoft, Xbox auth, Minecraft services).
- Redirects them to a local **sniproxy** (via DNS hijack).
- Proxies HTTPS/TLS traffic transparently back to the real servers (using SNI/Host inspection).
- For **all other domains**, DNS resolution falls through to **real upstream resolvers** (1.1.1.1 / 8.8.8.8).

👉 Useful for environments where you want to control, inspect, or route **only whitelisted domains**, while keeping everything else untouched.

---

## ✨ Features

- **Whitelist-based hijacking**  
  Only selected domains (supports **wildcards**) are hijacked. All others resolve normally.

- **Transparent proxy**  
  Clients think they are connecting directly to the real servers; traffic is routed via sniproxy.

- **Dockerized stack**  
  Runs **CoreDNS** (DNS hijacker) and **sniproxy** (SNI passthrough) with Docker Compose.

- **Safe host integration**  
  Frees port `:53` from `systemd-resolved` while keeping DNS functional on the Ubuntu host.

- **MTU probing enabled**  
  Prevents connection resets due to path MTU issues.

---

## ⚙️ Whitelisted Domains

By default, some domains are hijacked and redirected to the proxy:

You can edit the whitelist inside `setup.sh` to add/remove domains or widen to entire zones.

---

## 🛠 Installation

### Requirements
- Ubuntu 20.04+ (tested on Ubuntu 22.04)
- Root access (`sudo`)
- Working internet access for package/image pulls

### Setup
Clone the repo and run the installer:

```bash
git clone https://github.com/saeedesmaeili/phoenix-dns-proxy.git
cd phoenix-dns-proxy
chmod +x setup.sh
sudo ./setup.sh
```

This will:
1. Free port `53` from `systemd-resolved`.
2. Install Docker & Compose (if missing).
3. Write CoreDNS & sniproxy configs with whitelist rules.
4. Enable TCP MTU probing.
5. Start containers.

---

## 🚀 Usage

### Client Setup
Point your **client DNS server** to the **IP of this proxy server**:

```
DNS Server: <your-server-ip>
```

- Whitelisted Minecraft/Microsoft domains → hijacked to the proxy.
- All other domains → resolved with **real upstream DNS**.

### Health Check
Run:
```bash
dig @<server-ip> login.live.com
```
Should return the proxy’s IP.  
```bash
dig @<server-ip> example.com
```
Should return the real IP from upstream resolvers.

---

## 🔧 Configuration

- **Whitelist domains**: edit the `WHITELIST` array in `setup.sh`.  
  Supports **exact FQDNs** or **regex for wildcards**.

- **Upstream resolvers**: change inside `setup.sh` (default: Cloudflare `1.1.1.1` + Google `8.8.8.8`).

- **Proxy IP**: automatically detected via `hostname -I`.

- **MTU tuning**: enabled via sysctl (`tcp_mtu_probing=1`).

---

## 📂 Project Structure

```
phoenix-dns-proxy/
 ├─ setup.sh              # Automated setup script
 ├─ docker-compose.yml    # Orchestrates CoreDNS + sniproxy
 ├─ coredns/Corefile      # CoreDNS config (autogenerated)
 ├─ sniproxy/sniproxy.conf# sniproxy config (autogenerated)
 └─ logs/                 # Runtime logs for debugging
```

---

## 🐛 Troubleshooting

- **Port 53 in use**  
  Ensure no other process (like Docker-proxy or BIND) is bound to `:53`.

- **SERVFAIL on some domains**  
  Make sure whitelist regex uses single-escaped dots (`\.`) and includes `fallthrough`.

- **SSL errors (ERR_SSL_VERSION_OR_CIPHER_MISMATCH)**  
  Some servers enforce strict ALPN or TLS behaviors not supported by sniproxy. These must be whitelisted or excluded.

---

## 🤝 Contributing

1. Fork this repo.
2. Create a new feature branch (`git checkout -b feature/my-feature`).
3. Commit changes (`git commit -m "Add new feature"`).
4. Push the branch and open a PR.

---

## 📜 License

MIT License — see [LICENSE](LICENSE) for details.

---

## 📬 Contact

Maintainer: **Saeed Esmaeili**  
GitHub: [@saeedesmaeili](https://github.com/saeedesmaeili)  
Email: smaeily@gmail.com

---

## 🙏 Acknowledgments

- [CoreDNS](https://coredns.io/)  
- [sniproxy](https://github.com/dlundquist/sniproxy)  
- [Docker](https://www.docker.com/)  

Special thanks to the Minecraft and DevOps community for documenting auth endpoints.
